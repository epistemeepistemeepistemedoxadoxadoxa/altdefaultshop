<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart</title>
    <link rel="stylesheet" href="cart.css">
    <!-- Square Web Payments SDK -->
    <script src="https://sandbox.web.squarecdn.com/v1/square.js"></script>
</head>
<body>
    <div class="nav">
        <a href="index.html">Documentation</a>
        <a href="typefaces.html">Typefaces</a>
        <a href="cart.html">Bag</a>
    </div>

    <div class="cart-container">
        <h1>Bag</h1>
        <p id="item-count">Items: <span id="item-count-number">0</span></p>
        <div id="cart-items">
            <!-- Cart items will be dynamically inserted here -->
        </div>
        <div id="total">
            <strong>Total: $<span id="total-price">0.00</span></strong>
        </div>
        <div id="checkout-container">
            <div id="card-container"></div>
            <button id="checkout-button" disabled>Proceed to Checkout</button>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const cart = JSON.parse(localStorage.getItem("cart")) || [];
            const cartItemsContainer = document.getElementById("cart-items");
            const totalPriceElement = document.getElementById("total-price");
            const itemCountElement = document.getElementById("item-count-number");

            let totalPrice = 0;

            // Function to update the cart in localStorage
            function updateCart() {
                localStorage.setItem("cart", JSON.stringify(cart));
            }

            // Function to update the total price and item count
            function updateTotals() {
                totalPrice = 0;
                let itemCount = 0;

                cart.forEach(item => {
                    const itemTotal = (item.price * item.quantity) + (item.licensePrice || 0);
                    totalPrice += itemTotal;
                    itemCount += item.quantity;
                });

                totalPriceElement.textContent = totalPrice.toFixed(2);
                itemCountElement.textContent = itemCount;
            }

            // Function to render cart items
            function renderCartItems() {
                cartItemsContainer.innerHTML = ""; // Clear the container
                cart.forEach((item, index) => {
                    const itemElement = document.createElement("div");
                    itemElement.className = "cart-item";
                    itemElement.innerHTML = `
                        <div class="item-number">${index + 1}.</div>
                        <div class="item-details">
                            <span class="font-name">${item.fontName}</span>
                            <button class="explore-button" data-font="${item.fontName}">Explore ‚ü≥</button>
                            <span class="font-price">$${item.price.toFixed(2)}</span>
                        </div>
                        <div class="quantity-selector">
                            <label for="quantity-${index}">Quantity:</label>
                            <input type="number" id="quantity-${index}" class="quantity-input" min="0" value="${item.quantity}" data-index="${index}">
                        </div>
                        <div class="license-selection">
                            <label for="license-${index}">Select License:</label>
                            <select id="license-${index}" class="license-select" data-index="${index}">
                                <option value="0" selected>Personal Use (Base Price)</option>
                                <option value="50">Desktop - Up to 5 computers</option>
                                <option value="90">Desktop - Up to 10 computers</option>
                                <option value="150">Desktop - Up to 20 computers</option>
                                <option value="250">Desktop - Up to 35 computers</option>
                                <option value="350">Desktop - Up to 50 computers</option>
                                <option value="600">Desktop - Up to 100 computers</option>
                                <option value="1200">Desktop - Up to 250 computers</option>
                                <option value="2000">Desktop - Up to 500 computers</option>
                                <option value="contact">Desktop - More than 500 computers (Contact for pricing)</option>
                                <option value="40">Web - Up to 25,000 monthly pageviews</option>
                                <option value="70">Web - Up to 50,000 monthly pageviews</option>
                                <option value="120">Web - Up to 100,000 monthly pageviews</option>
                                <option value="200">Web - Up to 200,000 monthly pageviews</option>
                                <option value="300">Web - Up to 500,000 monthly pageviews</option>
                                <option value="500">Web - Up to 1,000,000 monthly pageviews</option>
                                <option value="800">Web - Up to 5,000,000 monthly pageviews</option>
                                <option value="1200">Web - Up to 10,000,000 monthly pageviews</option>
                                <option value="1800">Web - Up to 25,000,000 monthly pageviews</option>
                                <option value="2500">Web - Up to 50,000,000 monthly pageviews</option>
                                <option value="4000">Web - Up to 100,000,000 monthly pageviews</option>
                                <option value="contact">Web - More than 100,000,000 monthly pageviews (Contact for pricing)</option>
                                <option value="60">Mobile App - 1 App</option>
                                <option value="100">Mobile App - 2 Apps</option>
                                <option value="150">Mobile App - 3 Apps</option>
                                <option value="20">Ebook - Pricing per ebook or title</option>
                                <option value="contact">Logotype - Contact for pricing</option>
                                <option value="contact">TV/Cinema/Streaming - Contact for pricing</option>
                                <option value="contact">Social Media - Contact for pricing</option>
                                <option value="contact">Online Advertising - Contact for pricing</option>
                                <option value="contact">Student - Contact for pricing</option>
                            </select>
                            <span class="license-price">+$0.00</span>
                        </div>
                    `;
                    cartItemsContainer.appendChild(itemElement);

                    // Add event listener for quantity change
                    const quantityInput = itemElement.querySelector(`#quantity-${index}`);
                    quantityInput.addEventListener('change', () => {
                        const newQuantity = parseInt(quantityInput.value);
                        if (newQuantity === 0) {
                            cart.splice(index, 1);
                            updateCart();
                            renderCartItems();
                        } else {
                            item.quantity = newQuantity;
                            updateCart();
                            updateTotals();
                        }
                    });

                    // Add event listener for license selection
                    const licenseSelect = itemElement.querySelector(`#license-${index}`);
                    const licensePriceElement = itemElement.querySelector('.license-price');

                    licenseSelect.addEventListener('change', () => {
                        if (licenseSelect.value === "contact") {
                            licensePriceElement.textContent = "Contact for pricing";
                            item.licensePrice = 0;
                            alert("Please contact us for pricing details for this license.");
                        } else {
                            const selectedPrice = parseFloat(licenseSelect.value);
                            licensePriceElement.textContent = `+$${selectedPrice.toFixed(2)}`;
                            item.licensePrice = selectedPrice;
                        }
                        updateCart();
                        updateTotals();
                    });

                    // Initialize license price if it exists
                    if (item.licensePrice) {
                        licenseSelect.value = item.licensePrice;
                        licensePriceElement.textContent = `+$${item.licensePrice.toFixed(2)}`;
                    } else {
                        licenseSelect.value = 0;
                        licensePriceElement.textContent = "+$0.00";
                    }

                    // Add event listener for Explore button
                    const exploreButton = itemElement.querySelector('.explore-button');
                    exploreButton.addEventListener('click', () => {
                        const fontName = exploreButton.getAttribute('data-font');
                        alert(`Exploring ${fontName}`);
                    });
                });

                updateTotals();
            }

            // Initial render of cart items
            renderCartItems();

            // Square Checkout Integration
            async function initializeCheckout() {
                if (!window.Square) {
                    throw new Error('Square.js failed to load properly');
                }

                const payments = window.Square.payments('sq0idp-o9P_YfNZrVQKIlKPJw26_g', 'L4CVCS9X8T6SW');
                
                try {
                    const card = await payments.card();
                    await card.attach('#card-container');
                    
                    const button = document.getElementById('checkout-button');
                    button.disabled = false;
                    
                    button.addEventListener('click', async () => {
                        try {
                            const result = await payments.tokenize(card);
                            if (result.status === 'OK') {
                                const response = await fetch('https://square-payment-backend.onrender.com', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        sourceId: result.token,
                                        amount: Math.round(totalPrice * 100), // Convert to cents
                                    }),
                                });

                                const data = await response.json();
                                
                                if (data.success) {
                                    localStorage.removeItem("cart");
                                    window.location.href = "index.html";
                                } else {
                                    throw new Error(data.error || 'Payment failed');
                                }
                            }
                        } catch (e) {
                            console.error('Payment failed:', e);
                            alert('Payment failed. Please try again.');
                        }
                    });
                } catch (e) {
                    console.error('Failed to setup card:', e);
                    alert('Failed to set up payment system. Please refresh the page.');
                }
            }

            // Initialize the checkout
            initializeCheckout().catch(err => {
                console.error('Initialization failed:', err);
                alert('Failed to initialize payment system. Please refresh the page.');
            });
        });
    </script>
</body>
</html>